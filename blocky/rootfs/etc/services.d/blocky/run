#!/usr/bin/with-contenv bashio
# ==============================================================================
# Start Blocky service
# ==============================================================================

# shellcheck source=/dev/null
source /usr/local/lib/blocky-helpers.sh

declare -a options
readonly CONFIG_FILE="/etc/blocky/config.yml"

# Pre-flight checks
bashio::log.info "Performing pre-flight checks..."

# Check if config file exists
if [ ! -f "${CONFIG_FILE}" ]; then
    bashio::log.fatal "Configuration file not found: ${CONFIG_FILE}"
    exit 1
fi

# Check if config file is readable
if [ ! -r "${CONFIG_FILE}" ]; then
    bashio::log.fatal "Configuration file is not readable: ${CONFIG_FILE}"
    exit 1
fi

# Check if config file is not empty
if [ ! -s "${CONFIG_FILE}" ]; then
    bashio::log.fatal "Configuration file is empty: ${CONFIG_FILE}"
    exit 1
fi

# Validate configuration against Blocky's schema
# Scrub secrets from validation output to prevent password leakage in logs
bashio::log.info "Validating Blocky configuration..."
validate_output="$(blocky validate --config "${CONFIG_FILE}" 2>&1)" || {
    echo "${validate_output}" | scrub_secrets
    bashio::log.fatal "Configuration validation failed: ${CONFIG_FILE}"
    exit 1
}
echo "${validate_output}" | scrub_secrets

bashio::log.info "Pre-flight checks passed"
bashio::log.info "Starting Blocky..."

# Add configuration file
options+=(--config "${CONFIG_FILE}")

# Run Blocky
exec blocky "${options[@]}"
